version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/openjdk:17.0
    environment:
      TF_IN_AUTOMATION: "true"
    steps:
      - checkout

      # ① AWS 認証
      - run:
          name: Setup AWS credentials
          command: |
            mkdir -p ~/.aws 
            echo "[default]" > ~/.aws/credentials
            echo "aws_access_key_id = ${AWS_ACCESS_KEY_ID}" >> ~/.aws/credentials
            echo "aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}" >> ~/.aws/credentials
            echo "[default]" > ~/.aws/config
            echo "region = ap-northeast-1" >> ~/.aws/config
      
      - run:
          name: Install Terraform CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y curl gnupg software-properties-common

            curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
            
            sudo apt-get update
            sudo apt-get install -y terraform

      # ② Terraform 実行
      - run:
          name: Terraform Init & Apply
          working_directory: terraform
          command: |
            terraform init
            terraform validate
            terraform plan -out=tfplan \
              -var="allowed_ssh_cidr=221.49.49.27/32" \
              -var="db_password=${DB_PASSWORD}"
            terraform apply -auto-approve tfplan

      # 1. JAR ビルド (app ディレクトリで実行)
      - run:
          name: Build Spring Boot JAR
          working_directory: app 
          command: |
            # gradlew に実行権限を付与 (CI環境での保険)
            chmod +x gradlew
            
            # app フォルダ内でビルドを実行
            ./gradlew bootJar 
      
      # 2. 成果物 (JAR) のコピー
      - run:
          name: Copy JAR for Deployment
          command: |
            # JARファイルは 'app/build/libs/' に生成されるため、ansible フォルダなどにコピー
            cp app/build/libs/*.jar ansible/ 


      # ④ Ansible インストール
      - run:
          name: Install Ansible
          command: |
            sudo apt-get update 
            sudo apt-get install -y ansible

      # Ansible Playbook 実行（EC2へJAR配置＆起動）
      - run:
          name: Run Ansible Playbook
          working_directory: ansible
          command: |
            echo "${SSH_PRIVATE_KEY}" > private.pem
            chmod 600 private.pem
            ansible-playbook -i inventory.ini site.yml --private-key private.pem -u ec2-user

workflows:
  deploy_workflow:
    jobs:
      - deploy
