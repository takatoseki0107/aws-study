version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/openjdk:17.0
    environment:
      TF_IN_AUTOMATION: "true"
    steps:
      - checkout

      # â‘  AWS èªè¨¼
      - run:
          name: Setup AWS credentials
          command: |
            mkdir -p ~/.aws 
            
            echo "[default]" > ~/.aws/credentials
            echo "aws_access_key_id = ${AWS_ACCESS_KEY_ID}" >> ~/.aws/credentials
            echo "aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}" >> ~/.aws/credentials
            echo "[default]" > ~/.aws/config
            echo "region = ap-northeast-1" >> ~/.aws/config
      
      - run:
          name: Install Terraform CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y wget unzip
            
            # Terraform CLIã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            # ðŸ’¡ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»»æ„ã®ã‚‚ã®ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ (ä¾‹: 1.7.0)
            TERRAFORM_VERSION="1.7.0"
            wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
            unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip
            sudo mv terraform /usr/local/bin/
            rm terraform_${TERRAFORM_VERSION}_linux_amd64.zip

      # --- ä»¥é™ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å¤‰æ›´ãªã— ---
      # â‘¡ Terraform å®Ÿè¡Œ
      - run:
          name: Terraform Init & Apply
          working_directory: terraform
          command: |
            terraform init
            terraform validate
            terraform plan -out=tfplan \
              -var="allowed_ssh_cidr=221.49.49.27/32" \
              -var="db_password=${DB_PASSWORD}"
            terraform apply -auto-approve tfplan

      # â‘¢ JDK 17 + Gradle ã§ Spring Boot ãƒ“ãƒ«ãƒ‰
      - run:
          name: Build Spring Boot JAR
          working_directory: app
          command: |
            ./gradlew bootJar

      # â‘£ Ansible ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - run:
          name: Install Ansible
          command: |
            sudo apt-get update 
            sudo apt-get install -y ansible

      # Ansible Playbook å®Ÿè¡Œï¼ˆEC2ã¸JARé…ç½®ï¼†èµ·å‹•ï¼‰
      - run:
          name: Run Ansible Playbook
          working_directory: ansible
          command: |
            echo "${SSH_PRIVATE_KEY}" > private.pem
            chmod 600 private.pem
            ansible-playbook -i inventory.ini site.yml --private-key private.pem -u ec2-user

workflows:
  deploy_workflow:
    jobs:
      - deploy
